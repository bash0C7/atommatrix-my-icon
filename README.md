# ATOM Matrix bash物理アイコン

ATOM Matrixで「bash」のカラーパターンをアニメーション表示する光る物理アイコンです。

## 概要

このプロジェクトは、PicoRuby (R2P2-ESP32)を使用してATOM Matrixの5x5 LEDマトリックスで複数のパターンを順次表示するアニメーションデモです。事前定義されたbashカラーパレットを使用して、4種類のパターンが切り替わりながら表示されます。

### 主な機能
- **カラーパレット**: https://x.com/bash0C7/photo のカラーパターン
- **パターンアニメーション**: 4種類のビットマスクパターンを順次表示
- **外部LED対応**: コメントアウト解除で外部LEDストリップにも対応（GPIO32）
- **メモリ最適化**: 組み込みシステム向けの効率的な実装

## デモの動作

1. **全点灯**: https://x.com/bash0C7/photo にそったパターンで全LEDが1秒間点灯してbashカラーパレットを表示
2. **パターン1**: "b"型のパターンで500ms表示
3. **パターン2**: "a"型のパターンで500ms表示  
4. **パターン3**: "s"型のパターンで500ms表示
5. **パターン4**: "h"型のパターンで500ms表示
6. **消灯**: 各パターン後に50ms消灯してメリハリを演出

## パターンとカラーのカスタマイズ

### bashカラーパレット

`src_components/R2P2-ESP32/storage/home/app.rb`の`bash_pattern`配列で25色のRGBカラーパレットを定義：

https://x.com/bash0C7/photo をもとにしたパターンを示している。

```ruby
bash_pattern = [
  [175, 144, 111], [182, 150, 114], [162, 35, 14], [148, 74, 57], [179, 144, 110],
  [179, 59, 10], [202, 97, 13], [194, 0, 9], [199, 0, 6], [201, 98, 13],
  [156, 91, 77], [168, 38, 5], [158, 0, 3], [194, 64, 10], [191, 81, 22],
  [202, 185, 154], [174, 50, 4], [200, 157, 94], [176, 20, 9], [163, 110, 73],
  [170, 0, 3], [193, 0, 7], [158, 26, 5], [191, 0, 6], [112, 0, 2]
]
```

### アニメーションパターン

4種類のビットマスクパターンがbashカラーパレットに適用されます：

```ruby
patterns = [
  # パターン1: 全点灯（1000ms）
  [[true, true, true, true, true,
    true, true, true, true, true,
    true, true, true, true, true,
    true, true, true, true, true,
    true, true, true, true, true], 1000],
    
  # パターン2-5: 各文字パターン（500ms）
  # 詳細は実装ファイルを参照
]
```

### カスタマイズ例

**独自カラーパレット**：
```ruby
my_pattern = [
  [255, 0, 0], [0, 255, 0], [0, 0, 255],  # RGB基本色
  # ... 25色まで定義
]
```

**独自アニメーション**：
```ruby
# ハート型パターンの追加
[[false, true, false, true, false,
  true, true, true, true, true,
  false, true, true, true, false,
  false, false, true, false, false,
  false, false, false, false, false], 600]
```

## セットアップとビルド

### 必要環境

**ハードウェア**:
- **ATOM Matrix ESP32デバイス** (必須) - M5Stack ATOM Matrix
  - ESP32-PICO-D4搭載、5x5 LEDマトリックス内蔵
  - MPU6886加速度センサー内蔵

**ソフトウェア**:
- **ESP-IDF** (`$HOME/esp/esp-idf/`にインストール) - 必須
  - インストール手順: https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/index.html#manual-installation
- **Homebrew** (macOS)

## クイックスタート

1. **リポジトリをクローン**:
   ```bash
   git clone [このリポジトリのURL]
   cd atommatrix-my-icon
   ```

2. **初期化**:
   ```bash
   rake init
   ```

3. **ATOM MatrixをUSBでPCに接続**

4. **ビルド・書き込み・実行**:
   ```bash
   rake
   ```
   bashパターンのアニメーションが開始！

5. **終了方法**:
   - ターミナルで `Ctrl+]` で終了して、USBケーブルを抜く

6. **モバイル運用**:
   USBモバイルバッテリーに接続すればPCレスで単体動作可能

### その他の開発用コマンド

```bash
# 開発用コマンド一覧
rake -T
```

## ハードウェア仕様

- **ESP32-PICO-D4**: 240MHz デュアルコア
- **5×5 LED Matrix**: WS2812C (GPIO 27)
- **MPU6886 IMU**: I2C接続 (SDA:25, SCL:21, アドレス:0x68)
- **プログラマブルボタン**: GPIO 39

## プログラム構造

### メインファイル

**`src_components/R2P2-ESP32/storage/home/app_int.rb`** - 内蔵LED用プログラム（通常用）
- GPIO27接続、5x5マトリックス通常方向（0,0が左上）
- bash文字が正常に読める向き

**`src_components/R2P2-ESP32/storage/home/app_ext.rb`** - 外付けLED用プログラム（反転済み）  
- GPIO32接続、5x5マトリックス180度回転方向（0,0が右下）
- 物理的にLEDマトリックスを180度回転させた配置用
- bash_patternとpatternsが全て180度回転済み

- LEDパターンの定義とカスタマイズはこのファイルを編集

### 主要コンポーネント

- **LED制御**: WS2812ドライバーによる5x5マトリックス制御
  - 内蔵LED（app_int.rb）: GPIO27
  - 外付けLED（app_ext.rb）: GPIO32、反転済みパターン
- **カラーパレット**: 事前定義された25色のbashカラーパターン
- **パターンアニメーション**: ビットマスクを用いた効率的なパターン切り替え
- **タイミング制御**: パターンごとの表示時間と消灯インターバル制御
- **外付けLED対応**: app_ext.rbはローテート配置を想定してパターンが反転済み

### メモリ効率化

- 事前割り当て配列でガベージコレクション負荷を軽減
- ビット演算によるパターンマスク適用
- 整数演算中心の高速処理

## トラブルシューティング

### よくある問題

1. **LEDが光らない**: GPIO 27の配線確認、電源供給確認
2. **外部LEDが動作しない**: GPIO 32の配線確認、コメントアウト解除確認
3. **パターンが正しく表示されない**: `patterns`配列のビットマスク設定確認
4. **色が期待通りでない**: `bash_pattern`のRGB値確認

### デバッグとモニタリング

プログラム実行中の動作確認：
- シリアルモニターで実行状況を確認可能
- パターン切り替えタイミングの調整
- 外部LED動作の個別テスト

## 外付けLED向け反転版の生成方法

外付けLEDを物理的にローテートして配置する場合、以下のプロンプトでClaude Codeに反転版を生成させることができます：

```
src_components/R2P2-ESP32/storage/home/app_int.rbをもとに、bash_patternと、patternsの各パターンを180度回転（水平・垂直両方向に反転）させて、src_components/R2P2-ESP32/storage/home/app_ext.rbとして保存してください。GPIO設定は32に変更してください。
```

このプロンプトにより：
- `bash_pattern`: 25色の配列が末尾から先頭に並び順を反転（5x5の(4,4)→(0,0)順）
- `patterns`: 各5x5パターンが180度回転（縦横反転、(0,0)→(4,4)が(4,4)→(0,0)になる）
- GPIO設定: 27（内蔵LED）から32（外付けLED）に変更

**LEDマトリックス座標系**：
- **app_int.rb**: 通常方向 - (0,0)左上、(4,4)右下、bash文字正読み
- **app_ext.rb**: 180度回転 - (0,0)右下、(4,4)左上、bash文字が物理回転時に正読み

## カスタマイズのヒント

1. **カラーパレット変更**: `bash_pattern`配列のRGB値を編集
2. **パターン追加**: `patterns`配列に新しいビットマスクを追加
3. **タイミング調整**: 各パターンの表示時間（duration）を調整
4. **外付けLED向け反転**: 上記プロンプトでローテート配置に対応
